name: ğŸ¦Š OFRP Builder (auto)
on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'ğŸŒ¿ OrangeFox Manifest Branch'
        required: true
        default: '14.1'
        type: choice
        options:
          - 12.1
          - 14.1
      DEVICE_TREE:
        description: 'ğŸ“± Device Tree URL'
        required: true
        default: 'https://github.com/xccxxcys/device_xiaomi_liuqin-TWRP-OF'
      DEVICE_TREE_BRANCH:
        description: 'ğŸŒ± Device Tree Branch'
        required: true
        default: 'main'
      DEVICE_PATH:
        description: 'ğŸ“‚ Specify your Device Path'
        required: true
        default: 'device/xiaomi/liuqin'
      DEVICE_NAME:
        description: 'ğŸ–¥ï¸ Specify your Device Codename'
        required: true
        default: 'liuqin'
      TARGET_API_LEVEL:
        description: 'ğŸ“¶ Specify Target API Level (14.1â†’34, 12.1â†’32)'
        required: true
        default: '34'
      LUNCH_TARGET:
        description: "ğŸ½ï¸ lunch twrp_ (default same as device name)"
        required: false
        default: 'liuqin'
      BUILD_PARTITION:
        description: 'ğŸ¯ Specify your Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
          - boot
          - recovery
          - vendorboot
      MAGISK_VERSION:
        description: 'ğŸ”§ Specify your Magisk Version'
        required: true
        default: 'MagiskAlpha'
        type: choice
        options:
          - Magisk
          - MagiskAlpha
          - MagiskDelta
      USE_PATCHES:
        description: 'ğŸ§© Apply wifi 14.1 patches'
        type: boolean
        required: true
        default: false
      USE_SKKK_PATCHES:
        description: 'ğŸ§© Apply skkk 12.1 patches'
        type: boolean
        required: true
        default: false

jobs:
  build:
    name: ğŸš€ Build OrangeFox by ${{ github.actor }}
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
      - name: â„¹ï¸ Show build info
        run: |
          if [ -n "${{ github.event.inputs.LUNCH_TARGET }}" ]; then
            echo "LUNCH_TARGET=${{ github.event.inputs.LUNCH_TARGET }}" >> "$GITHUB_ENV"
          else
            echo "LUNCH_TARGET=${{ github.event.inputs.DEVICE_NAME }}" >> "$GITHUB_ENV"
          fi
          {
            echo 'BUILD_INFO<<EOF'
            echo
            echo "ğŸ“± Device tree url: ${{ github.event.inputs.DEVICE_TREE }}"
            echo "ğŸŒ¿ Device tree branch: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}"
            echo "ğŸ“‚ Device path: ${{ github.event.inputs.DEVICE_PATH }}"
            echo "ğŸ–¥ï¸ Device name: ${{ github.event.inputs.DEVICE_NAME }}"
            echo "ğŸ“¶ Target API Level: ${{ github.event.inputs.TARGET_API_LEVEL }}"
            echo "ğŸ½ï¸ Lunch target: ${{ env.LUNCH_TARGET }}"
            echo "ğŸ¯ Build target: ${{ github.event.inputs.BUILD_PARTITION }}.img"
            echo "ğŸ“… Build date: $(date)"
            echo "ğŸ§© Apply wifi patches: ${{ github.event.inputs.USE_PATCHES }}"
            echo "ğŸ§© Apply skkk patches: ${{ github.event.inputs.USE_SKKK_PATCHES }}"
            echo
            echo EOF
          } >> "$GITHUB_ENV"
          echo "BUILD_DATE=$(date +%F)" >> "$GITHUB_ENV"

      - name: ğŸ§¹ Clean-up
        uses: rokibhasansagar/slimhub_actions@main
        
      - name: ğŸ’¾ Max Space
        uses: easimon/maximize-build-space@master
        
      - name: âš¡ Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          create-symlink: true

      - name: ğŸš€ Setup zram
        run: |
          sudo apt install linux-modules-extra-$(uname -r) zram-tools -y
          sudo modprobe zram
          sudo sed -i 's/^#PERCENT=50/PERCENT=90/' /etc/default/zramswap
          sudo sed -i 's/^#PRIORITY=100/PRIORITY=1000/' /etc/default/zramswap
          sudo systemctl restart zramswap
          zramctl

      - name: ğŸŒ Build Environment
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt update && sudo apt install software-properties-common lsb-release -y
          git config --global user.name ${{ github.actor }}
          git config --global user.email ${{ github.actor }}@users.noreply.github.com
          sudo curl -L -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod a+rx /usr/local/bin/repo
          
      - name: ğŸ“¥ Pull TWRP Source & Run OrangeFox Sync
        run: |
          WORKINGDIR=$(pwd)
          if [ "${{ inputs.MANIFEST_BRANCH }}" = "14.1" ]; then
            TWRP_REPO="https://github.com/nebrassy/platform_manifest_twrp_aosp.git"
            TWRP_BRANCH="twrp-14"
            repo init -u $TWRP_REPO -b $TWRP_BRANCH --depth=1
            repo sync
            git clone https://gitlab.com/OrangeFox/sync.git -b master
            chmod +x sync/orangefox_sync.sh
            cd sync
            ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path $WORKINGDIR
            cd $WORKINGDIR
          else
            git clone https://gitlab.com/OrangeFox/sync.git -b master
            chmod +x sync/orangefox_sync.sh
            cd sync
            ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path $WORKINGDIR
            cd $WORKINGDIR
          fi
          
      - name: ğŸ§© Apply skkk 12.1 patches
        if: ${{ inputs.USE_SKKK_PATCHES == true && inputs.MANIFEST_BRANCH == '12.1' }}
        run: |
          WORKINGDIR=$(pwd)
          sed -i 's/<project name="android_hardware_qcom_bootctrl" path="hardware\/qcom-caf\/bootctrl" remote="LineageOS" revision="lineage-19.1-caf" \/>/<project name="android_hardware_qcom_bootctrl" path="hardware\/qcom-caf\/bootctrl" remote="LineageOS" revision="lineage-21.0-caf" \/>/g' $WORKINGDIR/.repo/manifests/twrp-default.xml
          sed -i '/<project path="bootable\/recovery" name="android_bootable_recovery" remote="TeamWin" revision="android-12.1"\/>/d' $WORKINGDIR/.repo/manifests/twrp-default.xml
          mv $WORKINGDIR/bootable/recovery $WORKINGDIR/bootable/recovery-ofrp
          repo sync
          mv $WORKINGDIR/bootable/recovery-ofrp $WORKINGDIR/bootable/recovery
          cd $WORKINGDIR/bootable/recovery
          git fetch https://github.com/ymdzq/OrangeFox_Recovery fox_12.1 && git cherry-pick 36289fac..05b3e1b9 || echo "âš ï¸ 12.1åˆ†æ”¯skkkè¡¥ä¸åº”ç”¨å¤±è´¥/æ— æ–°è¡¥ä¸ï¼Œç»§ç»­æ„å»º"
          cd $WORKINGDIR

      - name: ğŸ§© Apply wifi 14.1 patches
        if: ${{ inputs.USE_PATCHES == true && inputs.MANIFEST_BRANCH == '14.1' }}
        run: |
          WORKINGDIR=$(pwd)
          cd $WORKINGDIR/bootable/recovery
          git apply $WORKINGDIR/${{ inputs.DEVICE_PATH }}/patches/*.patch || echo "âš ï¸ 14.1åˆ†æ”¯wifiè¡¥ä¸åº”ç”¨å¤±è´¥ï¼Œç»§ç»­æ„å»º"
          cd $WORKINGDIR
          git clone https://github.com/adontoo/android_external_libmicrohttpd -b ofox-14.1 external/libmicrohttpd
          rm -rf bionic
          git clone https://github.com/adontoo/OrangeFox-android_platform_bionic bionic

      - name: ğŸ“± Setup device
        run: |
          git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ${{ inputs.DEVICE_PATH }}
          DEVICE_TREE_URL="${{ inputs.DEVICE_TREE }}"
          [[ "${DEVICE_TREE_URL}" == *.git ]] && DEVICE_TREE_URL="${DEVICE_TREE_URL%.git}"
          echo "DEVICE_TREE_URL=${DEVICE_TREE_URL}" >> $GITHUB_ENV

      - name: ğŸ”§ Auto set API Level in device.mk
        run: |
          WORKINGDIR=$(pwd)
          TARGET_API_LEVEL="${{ inputs.TARGET_API_LEVEL }}"
          DEVICE_MK_PATH="$WORKINGDIR/${{ inputs.DEVICE_PATH }}/device.mk"
          if ! grep -q '^BOARD_SHIPPING_API_LEVEL' "$DEVICE_MK_PATH"; then
            echo "BOARD_SHIPPING_API_LEVEL := $TARGET_API_LEVEL" >> "$DEVICE_MK_PATH" && echo "âœ… Added BOARD_SHIPPING_API_LEVEL=$TARGET_API_LEVEL in $DEVICE_MK_PATH"
          else
            sed -i "s/^BOARD_SHIPPING_API_LEVEL\s*:=.*/BOARD_SHIPPING_API_LEVEL := $TARGET_API_LEVEL/" "$DEVICE_MK_PATH" && echo "âœ… Updated BOARD_SHIPPING_API_LEVEL to $TARGET_API_LEVEL in $DEVICE_MK_PATH"
          fi
          if ! grep -q '^PRODUCT_SHIPPING_API_LEVEL' "$DEVICE_MK_PATH"; then
            echo "PRODUCT_SHIPPING_API_LEVEL := $TARGET_API_LEVEL" >> "$DEVICE_MK_PATH" && echo "âœ… Added PRODUCT_SHIPPING_API_LEVEL=$TARGET_API_LEVEL in $DEVICE_MK_PATH"
          else
            sed -i "s/^PRODUCT_SHIPPING_API_LEVEL\s*:=.*/PRODUCT_SHIPPING_API_LEVEL := $TARGET_API_LEVEL/" "$DEVICE_MK_PATH" && echo "âœ… Updated PRODUCT_SHIPPING_API_LEVEL to $TARGET_API_LEVEL in $DEVICE_MK_PATH"
          fi

      - name: ğŸ”§ Clone OrangeFox Built-in Magisk
        run: |
          WORKINGDIR=$(pwd)
          git clone https://github.com/xccxxcys/twrp_prebuilt ~/twrp_prebuilt
          if ! grep -q 'FOX_USE_SPECIFIC_MAGISK_ZIP' $WORKINGDIR/vendorsetup.sh; then
            echo 'export FOX_USE_SPECIFIC_MAGISK_ZIP=~/twrp_prebuilt/Magisk/${{ inputs.MAGISK_VERSION }}.apk' >> $WORKINGDIR/vendorsetup.sh && echo "âœ… Added FOX_USE_SPECIFIC_MAGISK_ZIP in vendorsetup.sh"
          else
            sed -i 's/.*export FOX_USE_SPECIFIC_MAGISK_ZIP.*/export FOX_USE_SPECIFIC_MAGISK_ZIP=\~\/twrp_prebuilt\/Magisk\/${{ inputs.MAGISK_VERSION }}.apk/' $WORKINGDIR/vendorsetup.sh && echo "âœ… Updated FOX_USE_SPECIFIC_MAGISK_ZIP in vendorsetup.sh"
          fi

      - name: ğŸ”§ Update OrangeFox Built-in magiskboot
        run: |
          WORKINGDIR=$(pwd)
          sudo mkdir -p $WORKINGDIR/vendor/recovery/prebuilt/arm $WORKINGDIR/vendor/recovery/prebuilt/arm64 $WORKINGDIR/vendor/recovery/tools
          curl -L --retry 3 $(echo $(curl -s "https://api.github.com/repos/topjohnwu/Magisk/releases?per_page=1&include_prereleases=true") | jq -r '.[0].assets[] | select(.name | test("Magisk-.*\\.apk")) | .browser_download_url') -o Magisk.apk
          unzip -q Magisk.apk "lib/*/libmagiskboot.so" -d ~/magiskboot
          cp -f ~/magiskboot/lib/armeabi-v7a/libmagiskboot.so $WORKINGDIR/vendor/recovery/prebuilt/arm/magiskboot_updated
          cp -f ~/magiskboot/lib/arm64-v8a/libmagiskboot.so $WORKINGDIR/vendor/recovery/prebuilt/arm64/magiskboot_updated
          cp -f ~/magiskboot/lib/x86_64/libmagiskboot.so $WORKINGDIR/vendor/recovery/tools/magiskboot
          echo "âœ… Updated magiskboot successfully"

      - name: ğŸ“ Generate build info
        run: |
          echo -e "$BUILD_INFO" >> INFO.txt
          echo "ğŸ“œ Change log:" >> INFO.txt
          set +e
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
          if [ $? -eq 0 ]; then
            git log "$LAST_TAG"..HEAD --pretty=format:"- %h-%an: %s" >> INFO.txt
          else
            git log --pretty=format:"- %h-%an: %s" >> INFO.txt
          fi
          cat INFO.txt
        working-directory: ${{ inputs.DEVICE_PATH }}

      - name: ğŸ› ï¸ Build OFRP
        run: |
          set +e
          export MAKEFLAGS="-j$(nproc)"
          export CCACHE_DIR=.ccache
          export CCACHE_EXEC=$(command -v ccache)
          export CCACHE_MAXSIZE=5G
          export USE_CCACHE=1
          sed -i 's/return sandboxConfig\.working/return false/g' build/soong/ui/build/sandbox_linux.go
          source build/envsetup.sh
          export ALLOW_MISSING_DEPENDENCIES=true
          set -e
          # æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ® MANIFEST_BRANCH åŠ¨æ€é€‰æ‹© lunch æ ¼å¼
          if [ "${{ inputs.MANIFEST_BRANCH }}" = "14.1" ]; then
            # 14.1åˆ†æ”¯ï¼šç¬¦åˆ <product>-<release>-<variant> è§„èŒƒï¼ˆap2aä¸ºAndroid 14 releaseä»£å·ï¼‰
            lunch twrp_${{ env.LUNCH_TARGET }}-ap2a-eng
          elif [ "${{ inputs.MANIFEST_BRANCH }}" = "12.1" ]; then
            # 12.1åˆ†æ”¯ï¼šä¿æŒåŸæœ‰æ ¼å¼
            lunch twrp_${{ env.LUNCH_TARGET }}-eng
          else
            echo "âŒ Unsupported MANIFEST_BRANCH: ${{ inputs.MANIFEST_BRANCH }}"
            exit 1
          fi
          # åå°è¾“å‡ºæ„å»ºè¿›åº¦å’Œå†…å­˜ä½¿ç”¨æƒ…å†µ
          (while true; do echo `date +%T` "Building OFRP..."; free -h; sleep 10; done) &
          TIP_PID=$!
          # æ„å»ºå‘½ä»¤ï¼ˆä¿ç•™åŸé€»è¾‘ï¼Œä½¿ç”¨nproc-2é¿å…èµ„æºè€—å°½ï¼‰
          make -j$((`nproc` - 2)) adbd ${{ inputs.BUILD_PARTITION }}image
          kill $TIP_PID && exit 0

      - name: ğŸ“¤ Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.img
            out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.zip
          name: ğŸ¦Š OrangeFox-R11.3-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}-${{ github.run_id }}
          tag_name: ${{ env.BUILD_DATE }}-${{ github.run_id }}
          body: |
            ### OrangeFox Recovery Build - Unofficial
            ğŸ“Œ Build: fox_${{ inputs.MANIFEST_BRANCH }}
            ğŸ“± Device: [Device Tree/Branch](${{ env.DEVICE_TREE_URL }}/tree/${{ inputs.DEVICE_TREE_BRANCH }})
            âœ… Trigger Commit: [${{ github.sha }}](${{ env.DEVICE_TREE_URL }}/commit/${{ github.sha }})
            ğŸ”§ Magisk Version: ${{ inputs.MAGISK_VERSION }}
            ğŸ“¶ Target API Level: ${{ inputs.TARGET_API_LEVEL }}
            ğŸ§© Apply wifi 14.1 patches: ${{ inputs.USE_PATCHES }}
            ğŸ§© Apply skkk 12.1 patches: ${{ inputs.USE_SKKK_PATCHES }}
            ### âš ï¸ Warning
            - For ${{ inputs.DEVICE_NAME }} only!
          body_path: ${{ inputs.DEVICE_PATH }}/INFO.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
