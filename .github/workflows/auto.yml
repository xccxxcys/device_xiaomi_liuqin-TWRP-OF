name: ü¶ä OFRP Builder (auto)
on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'üåø OrangeFox Manifest Branch'
        required: true
        default: '14.1'
        type: choice
        options:
          - 12.1
          - 14.1
      DEVICE_TREE:
        description: 'üì± Device Tree URL'
        required: true
        default: 'https://github.com/xccxxcys/device_xiaomi_liuqin-TWRP-OF'
      DEVICE_TREE_BRANCH:
        description: 'üå± Device Tree Branch'
        required: true
        default: 'main'
      DEVICE_PATH:
        description: 'üìÇ Specify your Device Path'
        required: true
        default: 'device/xiaomi/liuqin'
      DEVICE_NAME:
        description: 'üñ•Ô∏è Specify your Device Codename'
        required: true
        default: 'liuqin'
      LUNCH_TARGET:
        description: "üçΩÔ∏è lunch twrp_ (default same as device name)"
        required: false
        default: 'liuqin'
      BUILD_PARTITION:
        description: 'üéØ Specify your Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
          - boot
          - recovery
          - vendorboot
      MAGISK_VERSION:
        description: 'üîß Specify your Magisk Version'
        required: true
        default: 'MagiskAlpha'#ÊàëÂñúÊ¨¢Ëøô‰∏™magiskÁâàÊú¨
        type: choice
        options:
          - Magisk
          - MagiskAlpha
          - MagiskDelta
      USE_CCACHE:
        description: '‚ö° Use ccache for compilation'
        type: boolean
        required: true
        default: true

jobs:
  build:
    name: üöÄ Build OrangeFox by ${{ github.actor }}
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
      - name: ‚ÑπÔ∏è Show build info
        run: |
          if [ -n "${{ github.event.inputs.LUNCH_TARGET }}" ]; then
            echo "LUNCH_TARGET=${{ github.event.inputs.LUNCH_TARGET }}" >> "$GITHUB_ENV"
          else
            echo "LUNCH_TARGET=${{ github.event.inputs.DEVICE_NAME }}" >> "$GITHUB_ENV"
          fi
          {
            echo 'BUILD_INFO<<EOF'
            echo
            echo "üì± Device tree url: ${{ github.event.inputs.DEVICE_TREE }}"  # ‰øÆÂ§çÔºöÂèÇÊï∞ÂêçÁªü‰∏ÄÔºàÂéüDEVICE_TREE_URL‚ÜíDEVICE_TREEÔºå‰∏éËæìÂÖ•ÂèÇÊï∞‰∏ÄËá¥Ôºâ
            echo "üåø Device tree branch: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}"
            echo "üìÇ Device path: ${{ github.event.inputs.DEVICE_PATH }}"
            echo "üñ•Ô∏è Device name: ${{ github.event.inputs.DEVICE_NAME }}"
            echo "üçΩÔ∏è Lunch target: ${{ env.LUNCH_TARGET }}"
            echo "üéØ Build target: ${{ github.event.inputs.BUILD_PARTITION }}.img"
            echo "üìÖ Build date: $(date)"
            echo
            echo EOF
          } >> "$GITHUB_ENV"
          echo "BUILD_DATE=$(date +%F)" >> "$GITHUB_ENV"

      - name: üßπ Clean-up
        uses: rokibhasansagar/slimhub_actions@main
        
      - name: üíæ Max Space
        uses: easimon/maximize-build-space@master
        
      - name: ‚ö° Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          create-symlink: true

      - name: üöÄ Setup zram
        run: |
          sudo apt install linux-modules-extra-$(uname -r) zram-tools -y
          sudo modprobe zram
          sudo sed -i 's/^#PERCENT=50/PERCENT=90/' /etc/default/zramswap
          sudo sed -i 's/^#PRIORITY=100/PRIORITY=1000/' /etc/default/zramswap
          sudo systemctl restart zramswap
          zramctl

      - name: üåê Build Environment
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt update && sudo apt upgrade -y
          sudo apt install repo -y
          git config --global user.name ${{ github.actor }}
          git config --global user.email ${{ github.actor }}@users.noreply.github.com

      - name: üì• Pull TWRP Source
        run: |
          if [ "${{ inputs.MANIFEST_BRANCH }}" = "14.1" ]; then
            TWRP_REPO="https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git"
            TWRP_BRANCH="twrp-14.1"
            repo init -u $TWRP_REPO -b $TWRP_BRANCH --depth=1
            repo sync
          fi

      - name: ü¶ä Run OrangeFox Sync
        run: |
          if [ "${{ inputs.MANIFEST_BRANCH }}" = "14.1" ]; then
            git clone https://gitlab.com/OrangeFox/sync.git -b master
            WORKINGDIR=$(pwd)
            chmod +x sync/orangefox_sync.sh
            cd sync
            ./orangefox_sync.sh --branch ${{ github.event.inputs.MANIFEST_BRANCH }} --path $WORKINGDIR
            cd $WORKINGDIR
          else
            WORKINGDIR=$(pwd)
            git clone https://gitlab.com/OrangeFox/sync.git -b master
            chmod +x sync/orangefox_sync.sh
            cd sync
            ./orangefox_sync.sh --branch ${{ github.event.inputs.MANIFEST_BRANCH }} --path $WORKINGDIR
          fi
                    
      - name: üß© Patch 12.1 Branch
        if: inputs.MANIFEST_BRANCH == '12.1'
        run: |
          WORKINGDIR=$(pwd)
          # ‰øÆÊîπtwrp-default.xml‰∏≠ÁöÑÈ°πÁõÆÈÖçÁΩÆ
          sed -i 's/<project name="android_hardware_qcom_bootctrl" path="hardware\/qcom-caf\/bootctrl" remote="LineageOS" revision="lineage-19.1-caf" \/>/<project name="android_hardware_qcom_bootctrl" path="hardware\/qcom-caf\/bootctrl" remote="LineageOS" revision="lineage-21.0-caf" \/>/g' $WORKINGDIR/.repo/manifests/twrp-default.xml
          sed -i '/<project path="bootable\/recovery" name="android_bootable_recovery" remote="TeamWin" revision="android-12.1"\/>/d' $WORKINGDIR/.repo/manifests/twrp-default.xml
          # Â§á‰ªΩÂπ∂ÂêåÊ≠•recoveryÊ∫êÁ†Å
          mv $WORKINGDIR/bootable/recovery $WORKINGDIR/bootable/recovery-ofrp
          repo sync
          mv $WORKINGDIR/bootable/recovery-ofrp $WORKINGDIR/bootable/recovery
          # ÊãâÂèñÂπ∂Â∫îÁî®OrangeFoxË°•‰∏ÅÔºàÊ∑ªÂä†ÂÆπÈîôÂ§ÑÁêÜÔºâ
          cd $WORKINGDIR/bootable/recovery
          git fetch https://github.com/ymdzq/OrangeFox_Recovery fox_12.1 && git cherry-pick 36289fac..05b3e1b9 || echo "‚ö†Ô∏è 12.1ÂàÜÊîØË°•‰∏ÅÂ∫îÁî®Â§±Ë¥•/Êó†Êñ∞Ë°•‰∏ÅÔºåÁªßÁª≠ÊûÑÂª∫"
          cd $WORKINGDIR

      # - name: üß© Patch 14.1 Branch
      #   if: inputs.MANIFEST_BRANCH == '14.1'
      #   run: |
      #      WORKINGDIR=$(pwd)
      #      cd $WORKINGDIR/bootable/recovery
      #      git fetch https://github.com/ymdzq/OrangeFox_Recovery fox_12.1 && git cherry-pick 36289fac..05b3e1b9 || echo "‚ö†Ô∏è 14.1ÂàÜÊîØË°•‰∏ÅÂ∫îÁî®Â§±Ë¥•/Êó†Êñ∞Ë°•‰∏ÅÔºåÁªßÁª≠ÊûÑÂª∫"
      #      cd $WORKINGDIR
      #‰∏çË¶ÅÂêØÁî®Ôºå‰ºöÂÜ≤Á™Å
         
      - name: üì± Setup device
        run: |
          git clone ${{ github.event.inputs.DEVICE_TREE }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} ${{ github.event.inputs.DEVICE_PATH }}
          # Â§ÑÁêÜËÆæÂ§áÊ†ëURLÔºàÂéªÈô§.gitÂêéÁºÄÔºåÁî®‰∫éReleaseÈìæÊé•Ôºâ
          DEVICE_TREE_URL="${{ github.event.inputs.DEVICE_TREE }}"
          [[ "${DEVICE_TREE_URL}" == *.git ]] && DEVICE_TREE_URL="${DEVICE_TREE_URL%.git}"
          echo "DEVICE_TREE_URL=${DEVICE_TREE_URL}" >> $GITHUB_ENV

      - name: üîß Clone OrangeFox Built-in Magisk
        run: |
          WORKINGDIR=$(pwd)
          # ÂÖãÈöÜÈ¢ÑÁºñËØëMagisk‰ªìÂ∫ì
          git clone https://github.com/xccxxcys/twrp_prebuilt ~/twrp_prebuilt
          # Â§ÑÁêÜvendorsetup.sh‰∏≠ÁöÑMagiskË∑ØÂæÑÈÖçÁΩÆÔºàÊ∑ªÂä†/Êõ¥Êñ∞ÁéØÂ¢ÉÂèòÈáèÔºâ
          if ! grep -q 'FOX_USE_SPECIFIC_MAGISK_ZIP' $WORKINGDIR/vendorsetup.sh; then 
            echo 'export FOX_USE_SPECIFIC_MAGISK_ZIP=~/twrp_prebuilt/Magisk/${{ inputs.MAGISK_VERSION }}.apk' >> $WORKINGDIR/vendorsetup.sh && echo "‚úÖ Added FOX_USE_SPECIFIC_MAGISK_ZIP in vendorsetup.sh"
          else 
            sed -i 's/.*export FOX_USE_SPECIFIC_MAGISK_ZIP.*/export FOX_USE_SPECIFIC_MAGISK_ZIP=\~\/twrp_prebuilt\/Magisk\/${{ inputs.MAGISK_VERSION }}.apk/' $WORKINGDIR/vendorsetup.sh && echo "‚úÖ Updated FOX_USE_SPECIFIC_MAGISK_ZIP in vendorsetup.sh"
          fi

      - name: üîß Update OrangeFox Built-in magiskboot
        run: |
          WORKINGDIR=$(pwd)
          # ÊèêÂâçÂàõÂª∫ÁõÆÊ†áÁõÆÂΩïÔºàÈÅøÂÖçË∑ØÂæÑ‰∏çÂ≠òÂú®Êä•ÈîôÔºâ
          sudo mkdir -p $WORKINGDIR/vendor/recovery/prebuilt/arm $WORKINGDIR/vendor/recovery/prebuilt/arm64 $WORKINGDIR/vendor/recovery/tools
          # ‰∏ãËΩΩÊúÄÊñ∞Magisk APKÔºàÊîØÊåÅÈ¢ÑÂèëÂ∏ÉÁâàÊú¨ÔºåÈáçËØï3Ê¨°ÊèêÈ´òÁ®≥ÂÆöÊÄßÔºâ
          curl -L --retry 3 $(echo $(curl -s "https://api.github.com/repos/topjohnwu/Magisk/releases?per_page=1&include_prereleases=true") | jq -r '.[0].assets[] | select(.name | test("Magisk-.*\\.apk")) | .browser_download_url') -o Magisk.apk
          # Ëß£ÂéãÂπ∂ÊèêÂèñ‰∏çÂêåÊû∂ÊûÑÁöÑlibmagiskboot.so
          unzip -q Magisk.apk "lib/*/libmagiskboot.so" -d ~/magiskboot
          # Â§çÂà∂Âà∞ÂØπÂ∫îÁõÆÂΩïÂπ∂ÂëΩÂêç
          cp -f ~/magiskboot/lib/armeabi-v7a/libmagiskboot.so $WORKINGDIR/vendor/recovery/prebuilt/arm/magiskboot_updated
          cp -f ~/magiskboot/lib/arm64-v8a/libmagiskboot.so $WORKINGDIR/vendor/recovery/prebuilt/arm64/magiskboot_updated
          cp -f ~/magiskboot/lib/x86_64/libmagiskboot.so $WORKINGDIR/vendor/recovery/tools/magiskboot
          echo "‚úÖ Updated magiskboot successfully"
          
      - name: üìù Generate build info
        run: |
          echo -e "$BUILD_INFO" >> INFO.txt
          echo "üìú Change log:" >> INFO.txt
          set +e
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
          if [ $? -eq 0 ]; then
            git log "$LAST_TAG"..HEAD --pretty=format:"- %h-%an: %s" >> INFO.txt
          else
            git log --pretty=format:"- %h-%an: %s" >> INFO.txt
          fi
          cat INFO.txt
        working-directory: ${{ github.event.inputs.DEVICE_PATH }}
        
      - name: üõ†Ô∏è Build OFRP
        run: |
          set +e
          export MAKEFLAGS="-j$(nproc)"
          if [[ ${{ inputs.USE_CCACHE }} == true ]]; then
            export CCACHE_DIR=.ccache
            export CCACHE_EXEC=$(command -v ccache)
            export CCACHE_MAXSIZE=5G
            export USE_CCACHE=1
            sed -i 's/return sandboxConfig\.working/return false/g' build/soong/ui/build/sandbox_linux.go
          fi
          source build/envsetup.sh
          export ALLOW_MISSING_DEPENDENCIES=true
          set -e
          lunch twrp_${{ env.LUNCH_TARGET }}-ap2a-eng
          (while true; do echo `date +%T` "Building OFRP..."; free -h; sleep 10; done) &
          TIP_PID=$!
          make -j$(nproc) adbd ${{ github.event.inputs.BUILD_PARTITION }}image
          kill $TIP_PID && exit 0

      - name: üì§ Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.img
            out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          name: ü¶ä OrangeFox-R11.3-${{ github.event.inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}-${{ github.run_id }}
          tag_name: ${{ env.BUILD_DATE }}-${{ github.run_id }}
          body: |
            ### OrangeFox Recovery Build - Unofficial
            üìå Build: fox_${{ inputs.MANIFEST_BRANCH }}
            üì± Device: [Device Tree/Branch](${{ env.DEVICE_TREE_URL }}/tree/${{ inputs.DEVICE_TREE_BRANCH }})
            ‚úÖ Trigger Commit: [${{ github.sha }}](${{ env.DEVICE_TREE_URL }}/commit/${{ github.sha }})
            üîß Magisk Version: ${{ inputs.MAGISK_VERSION }}
            
            ### ‚ö†Ô∏è Warning
            - For ${{ inputs.DEVICE_NAME }} only!
          body_path: ${{ github.event.inputs.DEVICE_PATH }}/INFO.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
