name: TWRP 16 Builder
on:
  workflow_dispatch:
    inputs:
      TWRP_MANIFEST_URL:
        description: "TWRP manifest url"
        required: true
        default: "https://github.com/ymdzq/manifest_twrp"
      TWRP_MANIFEST_BRANCH:
        description: "TWRP branch"
        required: true
        default: "twrp-16.0"
      DEVICE_TREE_URL:
        description: "Device tree url"
        required: true
        default: "https://github.com/xccxxcys/device_xiaomi_liuqin-TWRP-OF"
      DEVICE_TREE_BRANCH:
        description: "Device tree branch"
        required: true
        default: "main"
      DEVICE_PATH:
        description: "Device path"
        required: true
        default: "device/xiaomi/liuqin"
      DEVICE_NAME:
        description: "Device codename"
        required: true
        default: "liuqin"
      BUILD_TARGET:
        description: "Build target partition"
        required: true
        default: "recovery"
        type: choice
        options:
          - boot
          - recovery
          - vendorboot

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      # ç»Ÿä¸€ç¯å¢ƒå˜é‡ï¼Œé¿å…é‡å¤å¼•ç”¨
      BUILD_DATE: ${{ format('{0:YYYY-MM-DD}', github.event.head_commit.timestamp) }}
      REPO_NAME: ${{ github.event.repository.name }}
      CCACHE_MAXSIZE: "5G"  # åŠ å¤§ç¼“å­˜å®¹é‡ï¼Œé€‚é…å¤§å‹é¡¹ç›®
      TWRP_VERSION: "3.7.1-16"  # é›†ä¸­ç®¡ç†ç‰ˆæœ¬å·ï¼Œä¾¿äºä¿®æ”¹

    steps:
      - name: ğŸ“‹ Show build info
        run: |
          echo "=== Build Configuration ==="
          echo "Manifest: ${{ inputs.TWRP_MANIFEST_URL }} (${{ inputs.TWRP_MANIFEST_BRANCH }})"
          echo "Device Tree: ${{ inputs.DEVICE_TREE_URL }} (${{ inputs.DEVICE_TREE_BRANCH }})"
          echo "Device Path: ${{ inputs.DEVICE_PATH }}"
          echo "Build Target: ${{ inputs.BUILD_TARGET }}"
          echo "Build Date: $BUILD_DATE"
          echo "=========================="

      - name: ğŸ§¹ Cleanup & Maximize space
        uses: rokibhasansagar/slimhub_actions@main
        with:
          remove-dotnet: true
          remove-android: true
          remove-haskell: true

      - name: ğŸ“¦ Setup persistent ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          create-symlink: true
          max-size: ${{ env.CCACHE_MAXSIZE }}
          key: ${{ inputs.DEVICE_NAME }}-${{ inputs.BUILD_TARGET }}-ccache
          restore-keys: |
            ${{ inputs.DEVICE_NAME }}-${{ inputs.BUILD_TARGET }}-ccache
            ${{ inputs.DEVICE_NAME }}-ccache

      - name: ğŸ Optimize zram (memory boost)
        run: |
          set -e
          sudo apt update && sudo apt install -y zram-tools linux-modules-extra-$(uname -r)
          sudo modprobe zram
          sudo sed -i 's/^#PERCENT=50/PERCENT=95/' /etc/default/zramswap
          sudo sed -i 's/^#PRIORITY=100/PRIORITY=2000/' /etc/default/zramswap
          sudo systemctl restart zramswap
          zramctl | awk '{print "Zram Usage:", $1, $2, $3}'

      - name: ğŸ› ï¸ Setup build environment
        run: |
          set -e
          export DEBIAN_FRONTEND=noninteractive
          # å¿«é€Ÿå®‰è£…ä¾èµ–ï¼ˆè·³è¿‡æ¨èåŒ…ï¼ŒåŠ å¿«é€Ÿåº¦ï¼‰
          sudo apt update && sudo apt install -y --no-install-recommends \
            repo git-core gnupg flex bison gperf build-essential zip curl zlib1g-dev \
            gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev \
            libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip ccache \
            openjdk-17-jdk python3 python3-pip python3-dev
          # é…ç½®Gitèº«ä»½
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
    
      - name: ğŸ“¥ Sync source code (optimized)
        run: |
          set -e
          # åˆå§‹åŒ–repoï¼ˆæµ…å…‹éš†+å•åˆ†æ”¯ï¼Œå¤§å¹…æé€Ÿï¼‰
          repo init -u ${{ inputs.TWRP_MANIFEST_URL }} -b ${{ inputs.TWRP_MANIFEST_BRANCH }} \ --depth=1
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
          echo "Source sync completed successfully"

      - name: ğŸ“± Clone device tree
        run: |
          set -e
          # åˆ›å»ºè®¾å¤‡è·¯å¾„ï¼ˆé¿å…è·¯å¾„ä¸å­˜åœ¨æŠ¥é”™ï¼‰
          mkdir -p $(dirname ${{ inputs.DEVICE_PATH }})
          git clone ${{ inputs.DEVICE_TREE_URL }} -b ${{ inputs.DEVICE_TREE_BRANCH }} \ --depth=1 ${{ inputs.DEVICE_PATH }}

      - name: ğŸ“ Generate build info
        run: |
          set -e
          BUILD_INFO="TWRP Build Info
          =================
          Version: $TWRP_VERSION
          Device: ${{ inputs.DEVICE_NAME }}
          Manifest Branch: ${{ inputs.TWRP_MANIFEST_BRANCH }}
          Device Tree Branch: ${{ inputs.DEVICE_TREE_BRANCH }}
          Build Target: ${{ inputs.BUILD_TARGET }}
          Build Date: $BUILD_DATE
          GitHub Run ID: ${{ github.run_id }}
          "
          echo -e "$BUILD_INFO" > INFO.txt
          echo -e "\nChange Log:" >> INFO.txt
          # è·å–è®¾å¤‡æ ‘æäº¤æ—¥å¿—ï¼ˆé¿å…æ— æ ‡ç­¾æ—¶æŠ¥é”™ï¼‰
          cd ${{ inputs.DEVICE_PATH }}
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            LAST_TAG=$(git describe --tags --abbrev=0)
            git log --pretty=format:"- %h (%an): %s" $LAST_TAG..HEAD >> ../../INFO.txt
          else
            git log --pretty=format:"- %h (%an): %s" -n 20 >> ../../INFO.txt  # é™åˆ¶æ—¥å¿—é•¿åº¦
          fi
          cat ../../INFO.txt

      - name: ğŸ—ï¸ Build TWRP (with ccache & logs)
        run: |
          set -e
          # åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
          source build/envsetup.sh
          # é…ç½®ccache
          export ALLOW_MISSING_DEPENDENCIES=true
          export CCACHE_DIR=$GITHUB_WORKSPACE/.ccache
          export CCACHE_EXEC=$(command -v ccache)
          export USE_CCACHE=1
          # é¢„çƒ­ccacheï¼ˆåŠ å¿«ç¼–è¯‘ï¼‰
          ccache -s
          # å¼€å§‹æ„å»ºï¼ˆlunchå‚æ•°è‡ªåŠ¨é€‚é…è®¾å¤‡è·¯å¾„ï¼‰
          lunch $(basename ${{ inputs.DEVICE_PATH }})-eng
          make clean
          # å¹¶è¡Œç¼–è¯‘ï¼ˆæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼Œè¾“å‡ºåˆ°æ–‡ä»¶ï¼‰
          make ${{ inputs.BUILD_TARGET }}image -j$(nproc --all) 2>&1 | tee build.log
          # éªŒè¯è¾“å‡ºæ–‡ä»¶
          OUTPUT_FILE="out/target/product/${{ inputs.DEVICE_NAME }}/${{ inputs.BUILD_TARGET }}.img"
          if [ ! -f "$OUTPUT_FILE" ]; then
            echo "Error: Build failed - Output file not found"
            exit 1
          fi
          # é‡å‘½åè¾“å‡ºæ–‡ä»¶ï¼ˆåŒ…å«å®Œæ•´ä¿¡æ¯ï¼‰
          mv "$OUTPUT_FILE" "out/target/product/${{ inputs.DEVICE_NAME }}/TWRP-${TWRP_VERSION}-${{ inputs.DEVICE_NAME }}-${BUILD_DATE}.img"
          echo "Build completed successfully!"
          ccache -s  # æ˜¾ç¤ºccacheä½¿ç”¨æƒ…å†µ

      - name: ğŸ“¤ Upload build artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            out/target/product/${{ inputs.DEVICE_NAME }}/TWRP-${{ env.TWRP_VERSION }}-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}.img
            build.log
            INFO.txt
          name: TWRP-${{ env.TWRP_VERSION }}-${{ inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}
          tag_name: ${{ env.BUILD_DATE }}-${{ inputs.DEVICE_NAME }}-${{ github.run_id }}
          body_path: INFO.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}